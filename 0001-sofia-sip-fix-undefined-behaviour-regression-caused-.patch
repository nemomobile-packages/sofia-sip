From 8013711c7bde414e2cf188278ce31f0cc96ca411 Mon Sep 17 00:00:00 2001
From: Jonni Rainisto <jonni.rainisto@jollamobile.com>
Date: Mon, 25 May 2015 11:51:02 +0000
Subject: [PATCH] [sofia-sip] fix undefined behaviour regression caused by new
 gcc. Contributes to JB#18922

---
 libsofia-sip-ua/msg/msg_parser.c | 19 ++++++++++++++-----
 1 file changed, 14 insertions(+), 5 deletions(-)

diff --git a/libsofia-sip-ua/msg/msg_parser.c b/libsofia-sip-ua/msg/msg_parser.c
index 3225714..1ca8a65 100644
--- a/libsofia-sip-ua/msg/msg_parser.c
+++ b/libsofia-sip-ua/msg/msg_parser.c
@@ -2468,8 +2468,6 @@ int msg_header_prepend(msg_t *msg,
 msg_header_t **
 msg_hclass_offset(msg_mclass_t const *mc, msg_pub_t const *mo, msg_hclass_t *hc)
 {
-  int i;
-
   assert(mc && hc);
 
   if (mc == NULL || hc == NULL)
@@ -2484,9 +2482,20 @@ msg_hclass_offset(msg_mclass_t const *mc, msg_pub_t const *mo, msg_hclass_t *hc)
   }
   else
     /* Header has no name. */
-    for (i = 0; i <= 6; i++)
-      if (hc->hc_hash == mc->mc_request[i].hr_class->hc_hash)
-	return (msg_header_t **)((char *)mo + mc->mc_request[i].hr_offset);
+    if      (hc->hc_hash == mc->mc_request[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_request[0].hr_offset);
+    else if (hc->hc_hash == mc->mc_status[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_status[0].hr_offset);
+    else if (hc->hc_hash == mc->mc_separator[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_separator[0].hr_offset);
+    else if (hc->hc_hash == mc->mc_payload[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_payload[0].hr_offset);
+    else if (hc->hc_hash == mc->mc_unknown[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_unknown[0].hr_offset);
+    else if (hc->hc_hash == mc->mc_error[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_error[0].hr_offset);
+    else if (hc->hc_hash == mc->mc_multipart[0].hr_class->hc_hash)
+       return (msg_header_t **)((char *)mo + mc->mc_multipart[0].hr_offset);
 
   return NULL;
 }
-- 
1.8.2

